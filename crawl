#!/bin/bash
domain="$(echo $1)"
start="$(echo $1)"
if [[ ${1: -1} == "/" ]]; then
  start="$(echo "${1::-1}")"
  domain="echo $start"
fi
declare -a url=($start)
seen=0
#printf '%s\n' "${url[@]}"

parsePage () {

  for l in "${!url[@]}"
  do
    : 
    if [[ "$l" -lt "$seen" ]]; then
      continue
    fi
    i="$(echo ${url[$l]})"
    if [[ ${i: -1} == "/" ]]; then
      i="$(echo "${i::-1}")"
    fi
    output="$(wget -qO- ${i})"
    links="$(echo "$output" | grep -Po '(?<=href=")[^"]*')"
    ((seen+=1))
    desiredLinks
  done

}

desiredLinks () {
  folder=""
  Assets1="$(echo "$links" | grep '^/' | grep "\.")"
  Assets2="$(echo "$links" | grep '^./' |  cut -c 2- | grep "\.")"
  Assets3="$(echo "$links" | grep "^$i" | cut -c $((${#i} + 1))- | grep "\." | grep -v "\.com")"
  echo "$Assets3"
  if [[ ! -z $(echo "$Assets1$Assets2$Assets3")  ]]; then
    Assets="$(echo "$Assets1$Assets2$Assets3" | sort | awk '{print "'"$i"'" $0}')"
  fi
  printf '\t%s\n' "{"
  printf '\t\t%s%s%s\n' "\"url\": \"" "$i" "\","
  printf '\t\t%s\n' "\"assets\": ["
  IFS=$'\n'
  for j in ""$Assets""
  do
    : 
    printf '\t\t\t%s\n' "$j"
  done
  printf '\t\t%s\n' "]"
  printf '\t%s\n' "}"
  relativeLinks1="$(echo "$links" | grep "^./" | cut -c 2-| grep -v "\." | awk '{print "'"$i"'" $0}')"
  relativeLinks2="$(echo "$links" | grep "^/" | grep -v "\." | awk '{print "'"$domain"'" $0}')"
  regularLinks="$(echo "$links" | grep "^$i" | cut -c $((${#i} + 1))- | grep -v "\." | awk '{print "'"$i"'" $0}')"
  Rlinks="$(echo "$relativeLinks1$relativeLinks2$regularLinks" | sort )"
  Rlinks="$(printf "%s\n" "$Rlinks" | uniq -u)"
  for k in ""$Rlinks""
  do
    :
    if [[ ${k: -1} == "/" ]]; then
      k="$(echo "${k::-1}")"
    fi
    if [[ ! " ${url[@]} " =~ " ${k} " ]]; then
      url+=($k)
    fi
  done
  removeDuplicates
  parsePage
}

removeDuplicates () {
  url=($(echo ${url[@]} | tr [:space:] '\n' | awk '!a[$0]++'))
}

printf '%s\n' "["
parsePage
printf '%s\n' "]"
